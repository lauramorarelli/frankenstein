<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Frankenstein's Unlocked Secrets - Escape Room</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;600&family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              pastel: {
                bg: '#FFF5E4',
                card: '#FFFFFF',
                primary: '#FFB3BA', // Red/Pink
                secondary: '#BAFFC9', // Green
                accent: '#BAE1FF', // Blue
                warning: '#FFFFBA', // Yellow
                text: '#5D5D5D'
              }
            },
            fontFamily: {
              sans: ['Nunito', 'sans-serif'],
              display: ['Fredoka', 'sans-serif'],
            }
          }
        }
      }
    </script>
    <style>
        body { background-color: #FFF5E4; color: #5D5D5D; }
        .slide-in { animation: slideIn 0.5s ease-out; }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .correct-anim { animation: pulseGreen 0.5s; }
        .wrong-anim { animation: shakeRed 0.5s; }
        @keyframes pulseGreen { 0% { transform: scale(1); } 50% { transform: scale(1.05); background-color: #BAFFC9; } 100% { transform: scale(1); } }
        @keyframes shakeRed { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        
        /* Drag and Drop Styles */
        .word-chip {
            cursor: grab;
            user-select: none;
            transition: transform 0.1s;
        }
        .word-chip:active {
            cursor: grabbing;
            transform: scale(1.05);
        }
        .gap-slot {
            display: inline-block;
            min-width: 100px;
            min-height: 2.5rem;
            vertical-align: middle;
            background-color: #FFF;
            border: 2px dashed #CBD5E1;
            border-radius: 0.5rem;
            margin: 0 0.25rem;
            padding: 0.25rem;
            transition: all 0.2s;
            text-align: center;
        }
        .gap-slot.drag-over {
            background-color: #E2E8F0;
            border-color: #94A3B8;
        }
        .gap-slot.filled {
            border-style: solid;
            background-color: #F8FAFC;
        }
        .gap-slot.correct {
            border-color: #4ADE80;
            background-color: #F0FDF4;
        }
        .gap-slot.wrong {
            border-color: #F87171;
            background-color: #FEF2F2;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4 bg-pastel-bg">

    

    <div id="app" class="w-full max-w-4xl ">
        <!-- Dynamic Content Will Be Injected Here -->
    </div>

    <script>
        const gameData = {"title":"Frankenstein's Unlocked Secrets","introText":"Welcome, intrepid learner, to the chilling world of Frankenstein! Dr. Victor Frankenstein, consumed by ambition, dared to play God and create life. But his monstrous creation, rejected and alone, brought only tragedy. Now, you find yourself trapped in his abandoned laboratory. To escape, you must decipher the secrets of his story, understand the Creature's plight, and unravel the ethical dilemmas that haunt this classic tale. Can you piece together the clues and unlock the truth before the darkness consumes you?","mcqSet1":[{"question":"Who were Mary Shelley's parents?","options":["William Godwin and Jane Austen","Lord Byron and Mary Wollstonecraft","William Godwin and Mary Wollstonecraft","Percy Shelley and Mary Wollstonecraft"],"correctIndex":2},{"question":"What was Mary Shelley's personal experience that influenced her obsession with giving life?","options":["She was a doctor studying anatomy.","She lost her mother and her own children.","She was fascinated by ancient myths.","She witnessed a scientific experiment."],"correctIndex":1},{"question":"What historical period does Frankenstein reflect?","options":["The Age of Enlightenment","The Age of Revolutions","The Industrial Revolution","The Renaissance"],"correctIndex":1},{"question":"According to the text, what is a key focus of the class's pedagogical approach to literature?","options":["Memorising plot details.","Understanding, thinking, and interpreting.","Identifying grammar rules.","Learning about author biographies."],"correctIndex":1},{"question":"Frankenstein can be read as a metaphor for what two main aspects?","options":["Cooking and gardening.","Individual life and society.","Math and science.","Art and music."],"correctIndex":1},{"question":"What is the Socratic Method (Maieutics) used by the teacher?","options":["Lecturing without interruption.","Making students copy notes.","Asking questions to stimulate students to think.","Showing films without discussion."],"correctIndex":2},{"question":"What scientific idea did Victor experiment with to make a dead body move?","options":["Astronomy","Alchemy","Galvanism","Botany"],"correctIndex":2},{"question":"What is the book's full title?","options":["Frankenstein, or The Modern Sorcerer","Frankenstein, or The New Human","Frankenstein, or The Modern Prometheus","Frankenstein, or The Electric Man"],"correctIndex":2},{"question":"What drives Victor?","options":["His love for nature.","His desire for eternal fame.","His fear of failure.","His commitment to ethical science."],"correctIndex":1},{"question":"How does society typically react to the unfamiliar or unknown, according to the text?","options":["With acceptance.","With curiosity and understanding.","With fear, as a basic survival instinct.","With indifference."],"correctIndex":2}],"mcqSet2":[{"question":"What is the central conflict of the novel regarding society?","options":["The conflict between rich and poor.","How society reacts to someone who cannot be easily categorised.","The struggle for political power.","The debate over scientific funding."],"correctIndex":1},{"question":"Why do people immediately perceive the Creature as frightening?","options":["He speaks in a strange language.","He wears unusual clothes.","His body is made of corpse parts.","He sings terrible songs."],"correctIndex":2},{"question":"Who is the one character who judges the Creature by his character rather than his looks?","options":["Victor Frankenstein","Captain Walton","The blind man","A girl in the village"],"correctIndex":2},{"question":"According to attachment theory, what does a first caregiver shape?","options":["A person's career choice.","How a person will form relationships in the future.","A person's favourite colour.","A person's athletic abilities."],"correctIndex":1},{"question":"How did Victor Frankenstein, the Creature's creator, react to his creation?","options":["With joy and pride.","With horror and abandonment.","With scientific curiosity.","With immediate acceptance."],"correctIndex":1},{"question":"What impact does Victor's rejection have on the Creature's identity?","options":["It makes him stronger.","It boosts his self-esteem.","He never learns trust and develops a negative identity.","He becomes a great artist."],"correctIndex":2},{"question":"What is the Creature's psychological response to pain and rejection?","options":["He becomes a hermit.","He becomes evil","He is indifferent"],"correctIndex":1},{"question":"What does the Creature beg Victor to create for him?","options":["A new home.","A female companion.","A book to read.","A map of the world."],"correctIndex":1},{"question":"What does the Creature discover while hiding near a family?","options":["How to build a house.","How to read and speak.","How to cook a meal.","How to disappear without a trace."],"correctIndex":1},{"question":"What happens when the Creature tries to help the blind man's family?","options":["He is welcomed and accepted.","He is given food and shelter.","He is rejected again due to a misunderstanding.","He is offered a job."],"correctIndex":2}],"matchingSet1":[{"left":"Mary Shelley used writing","right":"to process her grief and personal difficulties."},{"left":"The novel reflects","right":"a period full of curiosity, change, and scientific experimentation."},{"left":"Frankenstein can be read as a psychological metaphor","right":"for individual life and for society."},{"left":"Maieutics (Socratic Method) forces students","right":"to think, reason, and interpret"},{"left":"Meaning in literature is often co-constructed","right":"by the author and the reader."},{"left":"Victor experiments with galvanism,","right":"the idea that electricity could make a dead body move again."},{"left":"The Modern Prometheus refers to Victor's attempt","right":"to play god"},{"left":"The Creature's body is made of corpse parts,","right":"so people immediately see him as frightening."},{"left":"When the Creature meets a blind man,","right":"he is judged by character, not by looks."},{"left":"Victor Frankenstein reacted to his creation","right":"with horror and abandonment."},{"left":"The Creature's first experience of the world","right":"is rejection, destroying healthy development."},{"left":"The Creature develops hate","right":"as a psychological response to pain."},{"left":"The Creature begs Victor","right":"to create a female companion."},{"left":"The Creature learns to read and speak","right":"while hiding near a family."}],"matchingSet2":[{"left":"Victor Frankenstein wanted knowledge","right":"without thinking of the consequences."},{"left":"The Creature's hatred for Victor","right":"leads him to murder William."},{"left":"An innocent girl is accused of murder","right":"because the Creature blames her."},{"left":"The mob is frightened and","right":"wants to lynch the accused girl without a trial."},{"left":"The Creature says he feels","right":"both great love and great anger."},{"left":"Frankenstein tells Captain Walton he should be more rational","right":"and sees Walton is also obsessed."},{"left":"The Creature acts like a baby","right":"who has to learn everything"},{"left":"The story shows that every person","right":"has both good and evil inside them."},{"left":"Frankenstein fits the Gothic style","right":"(dark, mysterious, emotional)."},{"left":"Victor is compared to Prometheus","right":"who was punished for giving fire to the Gods"},{"left":"The Creature has no name,","right":"which is important because a name gives you identity."},{"left":"Captain Walton appears","right":"at the beginning and at the end of the story."},{"left":"The North represents","right":"isolation and the unknown."},{"left":"Oscar Wilde said a book is good","right":"if it makes us think."}],"fillGap":{"textWithPlaceholders":"Mary Shelley was the daughter of two important intellectuals: William Godwin and Mary Wollstonecraft. Shelley‚Äôs mother died only a week after Mary was born, and later in life Shelley also lost her own children. These painful experiences created a deep obsession with the idea of [GAP] life. Shelley used writing to [GAP] her grief and personal difficulties. The novel reflects a period full of curiosity, change, and scientific experimentation. The teacher often stops the film or discussion to ask questions. This method (maieutics) forces students to think, reason, and ‚Äúopen the sense‚Äù of the text. When students discover ideas on their own, they [GAP] them better. Meaning is created together by the author and the reader. The story begins with Captain Walton [GAP] the dangerous, unknown North Pole. This physical journey mirrors Dr. Frankenstein‚Äôs own journey into [GAP] scientific territory. Victor is driven by a ‚Äúlust for knowledge‚Äù and a sense of omnipotence. But when science enters unknown territory without control, the consequences can be dangerous. The central conflict of the novel is how society [GAP] to someone who cannot be easily categorised. Since the blind man cannot see his appearance, he judges him by character, not by looks. He builds a relationship based on [GAP]. The Creature becomes an example of how trauma and lack of attachment can lead to [GAP] behaviour.","answers":["giving","process","remember","exploring","forbidden","reacts","trust","antisocial"],"distractors":["finding","showing","forget","studying"]},"openQuestions":[{"question":"How does Victor's rejection of the Creature influence the Creature's development?","modelAnswer":"Victor's immediate rejection and abandonment of the Creature cause severe psychological trauma, leading to a destroyed sense of self, an inability to trust, and the development of antisocial and violent behaviour as a response to his pain and loneliness. The Creature's identity is negatively imprinted by this initial rejection."},{"question":"How are Victor and Captain Walton similar in their ambition and behaviour?","modelAnswer":"Both Victor Frankenstein and Captain Walton are driven by an intense desire for knowledge and glory, pushing into unknown territories (scientific for Victor, geographical for Walton). They both exhibit a dangerous obsession, neglecting consequences and the well-being of others, although Walton eventually learns from Victor's tragic mistakes."}]};
        const isPreview = false;
        
        let state = {
            step: 0, // 0: Intro, 1: MCQ1, 2: MCQ2, 3: Match1, 4: Match2, 5: FillGap, 6: OpenQ, 7: Success
            scores: {},
            mcq1Selections: {}, // Separate state for Set 1
            mcq2Selections: {}, // Separate state for Set 2
            currentMatchSelections: { left: null, right: null, found: [] },
            gapPlacements: {}, // { gapIndex: 'wordText' }
            openQRevealed: [false, false]
        };

        const app = document.getElementById('app');

        function render() {
            app.innerHTML = '';
            
            if (state.step === 0) renderIntro();
            else if (state.step === 1) renderMCQ(gameData.mcqSet1, 'Challenge 1: The First Test', 'mcq1Selections');
            else if (state.step === 2) renderMCQ(gameData.mcqSet2, 'Challenge 2: The Second Obstacle', 'mcq2Selections');
            else if (state.step === 3) renderMatching(gameData.matchingSet1, 'Challenge 3: Connect Concepts');
            else if (state.step === 4) renderMatching(gameData.matchingSet2, 'Challenge 4: Build Sentences');
            else if (state.step === 5) renderFillGap(gameData.fillGap, 'Challenge 5: Missing Words');
            else if (state.step === 6) renderOpenQuestions(gameData.openQuestions, 'Challenge 6: The Final Gate');
            else if (state.step === 7) renderSuccess();
        }

        // --- RENDERERS ---

        function renderIntro() {
            const div = document.createElement('div');
            div.className = 'bg-white rounded-3xl shadow-xl p-8 text-center slide-in border-b-8 border-pastel-primary';
            div.innerHTML = `
                <h1 class="text-4xl md:text-6xl font-display font-bold text-pastel-primary mb-6">${gameData.title}</h1>
                <p class="text-xl text-gray-600 mb-8 leading-relaxed">${gameData.introText}</p>
                <button onclick="nextStep()" class="bg-pastel-primary hover:bg-red-300 text-white font-bold py-4 px-10 rounded-full text-xl transition transform hover:scale-105 shadow-md">
                    Start Adventure
                </button>
            `;
            app.appendChild(div);
        }

        function renderMCQ(questions, title, stateKey) {
            const currentSelections = state[stateKey];
            const container = document.createElement('div');
            container.className = 'bg-white rounded-3xl shadow-xl p-6 md:p-10 slide-in border-b-8 border-pastel-accent';
            
            let html = `
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-display font-bold text-pastel-accent">${title}</h2>
                    <span class="bg-blue-100 text-blue-600 px-4 py-1 rounded-full text-sm font-bold">10 Questions</span>
                </div>
                <div class="space-y-8">
            `;

            questions.forEach((q, idx) => {
                const isCorrect = currentSelections[idx] === q.correctIndex;
                const isSelected = currentSelections[idx] !== undefined;
                const statusClass = isSelected ? (isCorrect ? 'border-green-400 bg-green-50' : 'border-red-400 bg-red-50') : 'border-transparent';

                html += `
                    <div class="p-4 rounded-xl border-2 ${statusClass} transition-all">
                        <p class="font-bold text-lg mb-3">${idx + 1}. ${q.question}</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            ${q.options.map((opt, optIdx) => `
                                <button 
                                    onclick="handleMcqSelect('${stateKey}', ${idx}, ${optIdx})"
                                    class="text-left p-3 rounded-lg border border-gray-200 hover:bg-blue-50 transition ${currentSelections[idx] === optIdx ? 'bg-blue-100 ring-2 ring-blue-300' : ''}"
                                >
                                    ${opt}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                `;
            });

            const allCorrect = questions.every((q, i) => currentSelections[i] === q.correctIndex);

            html += `
                </div>
                <div class="mt-8 flex justify-end gap-3">
                    <button id="checkBtn" onclick="checkMcq('${stateKey}', 10)" class="bg-pastel-accent hover:bg-blue-300 text-white font-bold py-3 px-8 rounded-full text-lg transition shadow-md ${allCorrect ? 'hidden' : ''}">
                        Check Answers
                    </button>
                    <button onclick="nextStep()" class="bg-green-400 hover:bg-green-500 text-white font-bold py-3 px-8 rounded-full text-lg transition shadow-md ${allCorrect || isPreview ? '' : 'hidden'}">
                        ${isPreview && !allCorrect ? 'Skip (Preview) ->' : 'Next Challenge ->'}
                    </button>
                </div>
            `;
            
            container.innerHTML = html;
            app.appendChild(container);
        }

        function renderMatching(pairs, title) {
            // Flatten and shuffle for display
            if (!state.shuffledLeft) {
                state.shuffledLeft = pairs.map((p, i) => ({ val: p.left, id: i })).sort(() => Math.random() - 0.5);
                state.shuffledRight = pairs.map((p, i) => ({ val: p.right, id: i })).sort(() => Math.random() - 0.5);
            }

            const container = document.createElement('div');
            container.className = 'bg-white rounded-3xl shadow-xl p-6 md:p-10 slide-in border-b-8 border-pastel-secondary';
            
            let html = `
                <h2 class="text-3xl font-display font-bold text-green-500 mb-6">${title}</h2>
                <p class="mb-4 text-gray-500">Select an item on the left, then find its match on the right.</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="space-y-3">
                        <h3 class="font-bold text-center text-gray-400 mb-2">Column A</h3>
                        ${state.shuffledLeft.map(item => {
                            const isFound = state.currentMatchSelections.found.includes(item.id);
                            const isSelected = state.currentMatchSelections.left === item.id;
                            let classes = "w-full p-4 rounded-xl border-2 transition text-left cursor-pointer ";
                            if (isFound) classes += "bg-green-100 border-green-300 opacity-50 cursor-default";
                            else if (isSelected) classes += "bg-yellow-100 border-yellow-300 ring-2 ring-yellow-200 transform scale-105";
                            else classes += "bg-gray-50 border-gray-200 hover:bg-gray-100";
                            
                            return `<div onclick="handleMatchSelect('left', ${item.id})" class="${classes}">${item.val}</div>`;
                        }).join('')}
                    </div>
                    <div class="space-y-3">
                        <h3 class="font-bold text-center text-gray-400 mb-2">Column B</h3>
                        ${state.shuffledRight.map(item => {
                             const isFound = state.currentMatchSelections.found.includes(item.id);
                             const isSelected = state.currentMatchSelections.right === item.id;
                             let classes = "w-full p-4 rounded-xl border-2 transition text-left cursor-pointer ";
                             if (isFound) classes += "bg-green-100 border-green-300 opacity-50 cursor-default";
                             else if (isSelected) classes += "bg-yellow-100 border-yellow-300 ring-2 ring-yellow-200 transform scale-105";
                             else classes += "bg-gray-50 border-gray-200 hover:bg-gray-100";
                            
                            return `<div onclick="handleMatchSelect('right', ${item.id})" class="${classes}">${item.val}</div>`;
                        }).join('')}
                    </div>
                </div>
                <div class="mt-8 flex justify-end">
                    <button onclick="nextStep()" class="bg-pastel-secondary hover:bg-green-400 text-white font-bold py-3 px-8 rounded-full text-lg transition shadow-md ${state.currentMatchSelections.found.length === 7 || isPreview ? '' : 'hidden'}">
                        ${isPreview && state.currentMatchSelections.found.length !== 7 ? 'Skip (Preview) ->' : 'Proceed ->'}
                    </button>
                </div>
            `;

            container.innerHTML = html;
            app.appendChild(container);
        }

        function renderFillGap(data, title) {
            const container = document.createElement('div');
            container.className = 'bg-white rounded-3xl shadow-xl p-6 md:p-10 slide-in border-b-8 border-pastel-orange';
            
            // Available words bank (answers + distractors shuffled)
            const allWords = [...data.answers, ...(data.distractors || [])].sort();
            
            // Filter out words that are already placed in a gap
            const placedWords = Object.values(state.gapPlacements);
            const availableWords = allWords.filter(w => {
                 // Logic to allow duplicates if the same word appears multiple times?
                 // For simplicity, we assume strict count or just use index tracking if words are identical
                 // Better: Create word objects with IDs.
                 // For this version, let's filter by counting occurrences
                 const totalCount = allWords.filter(aw => aw === w).length;
                 const placedCount = placedWords.filter(pw => pw === w).length;
                 return placedCount < totalCount;
            });

            // Prepare text parts
            const parts = data.textWithPlaceholders.split('[GAP]');
            
            let textHtml = '';
            parts.forEach((part, i) => {
                textHtml += `<span>${part}</span>`;
                if (i < parts.length - 1) {
                    const filledWord = state.gapPlacements[i];
                    let slotClass = 'gap-slot';
                    if (filledWord) slotClass += ' filled';
                    
                    // Check logic classes
                    if (state.gapChecked && filledWord) {
                        const isCorrect = filledWord.toLowerCase().trim() === data.answers[i].toLowerCase().trim();
                        slotClass += isCorrect ? ' correct' : ' wrong';
                    }

                    textHtml += `<span 
                        id="gap-${i}" 
                        class="${slotClass}"
                        ondrop="drop(event, ${i})" 
                        ondragover="allowDrop(event)"
                        onclick="returnWord(${i})"
                        title="${filledWord ? 'Click to remove' : ''}"
                    >${filledWord || ''}</span>`;
                }
            });
            
            // Check if all correct (for hiding/showing buttons on re-render)
            let correctCount = 0;
            const answers = data.answers;
            for(let i=0; i<answers.length; i++) {
                if (state.gapPlacements[i]?.toLowerCase().trim() === answers[i].toLowerCase().trim()) {
                    correctCount++;
                }
            }
            const allCorrect = correctCount === answers.length;

            let html = `
                <h2 class="text-3xl font-display font-bold text-orange-400 mb-6">${title}</h2>
                <p class="mb-4 text-gray-500 italic">Drag words from the bank below and drop them into the empty slots.</p>
                
                <div class="leading-loose text-lg text-justify p-6 bg-gray-50 rounded-xl border border-gray-100 mb-8" style="line-height: 2.5rem;">
                    ${textHtml}
                </div>

                <div id="wordBank" class="bg-orange-50 p-6 rounded-xl flex flex-wrap gap-3 justify-center min-h-[100px] border-2 border-orange-100 border-dashed ${allCorrect ? 'hidden' : ''}" ondrop="dropToBank(event)" ondragover="allowDrop(event)">
                    ${availableWords.map((w, idx) => `
                        <div 
                            id="word-${w}-${idx}" 
                            class="word-chip bg-white border border-orange-200 px-4 py-2 rounded-full text-gray-700 font-bold shadow-sm hover:shadow-md hover:scale-105" 
                            draggable="true" 
                            ondragstart="drag(event, '${w}')"
                        >
                            ${w}
                        </div>
                    `).join('')}
                </div>

                <div class="mt-8 flex justify-end gap-3">
                     <button id="checkGapBtn" onclick="checkGaps(${data.answers.length})" class="bg-orange-300 hover:bg-orange-400 text-white font-bold py-3 px-8 rounded-full text-lg transition shadow-md ${allCorrect ? 'hidden' : ''}">
                        Check Answers
                    </button>
                    <button id="nextGapBtn" onclick="nextStep()" class="bg-green-400 hover:bg-green-500 text-white font-bold py-3 px-8 rounded-full text-lg transition shadow-md ${allCorrect || isPreview ? '' : 'hidden'}">
                         ${isPreview && !allCorrect ? 'Skip (Preview) ->' : 'Next Challenge ->'}
                    </button>
                </div>
            `;

            container.innerHTML = html;
            app.appendChild(container);
        }

        function renderOpenQuestions(questions, title) {
            const container = document.createElement('div');
            container.className = 'bg-white rounded-3xl shadow-xl p-6 md:p-10 slide-in border-b-8 border-purple-300';
            
            let html = `
                <h2 class="text-3xl font-display font-bold text-purple-400 mb-6">${title}</h2>
                <div class="space-y-8">
            `;

            questions.forEach((q, idx) => {
                const isRevealed = state.openQRevealed[idx];
                html += `
                    <div class="bg-purple-50 p-6 rounded-2xl border border-purple-100">
                        <p class="font-bold text-lg mb-4">${idx + 1}. ${q.question}</p>
                        <textarea class="w-full p-4 rounded-xl border-2 border-purple-200 focus:border-purple-400 outline-none h-32 mb-4" placeholder="Write your answer here..."></textarea>
                        
                        <div class="${isRevealed ? '' : 'hidden'} bg-green-50 p-4 rounded-xl border border-green-200 mb-4 transition-all">
                            <p class="text-sm font-bold text-green-600 mb-1">Model Answer:</p>
                            <p class="text-gray-700 italic">${q.modelAnswer}</p>
                        </div>

                        <button onclick="revealAnswer(${idx})" class="${isRevealed ? 'hidden' : ''} bg-purple-300 text-white px-6 py-2 rounded-full font-bold hover:bg-purple-400 transition">
                            Show Answer
                        </button>
                         <button onclick="markReviewed(${idx})" class="${isRevealed && !state.openQReviewed?.[idx] ? '' : 'hidden'} bg-green-400 text-white px-6 py-2 rounded-full font-bold hover:bg-green-500 transition">
                            Got It
                        </button>
                         <span class="${state.openQReviewed?.[idx] ? '' : 'hidden'} text-green-500 font-bold ml-2">‚úì Reviewed</span>
                    </div>
                `;
            });

             const allReviewed = questions.every((q, i) => state.openQReviewed?.[i]);

            html += `
                </div>
                <div class="mt-8 flex justify-end">
                    <button onclick="nextStep()" class="bg-purple-400 hover:bg-purple-500 text-white font-bold py-3 px-8 rounded-full text-lg transition shadow-md ${allReviewed || isPreview ? '' : 'hidden'}">
                        ${isPreview && !allReviewed ? 'Skip (Preview) ->' : 'Finish Escape Room ->'}
                    </button>
                </div>
            `;

            container.innerHTML = html;
            app.appendChild(container);
        }

        function renderSuccess() {
            const container = document.createElement('div');
            container.className = 'bg-white rounded-3xl shadow-xl p-10 text-center slide-in border-b-8 border-yellow-300 max-w-2xl';
            container.innerHTML = `
                <div class="text-6xl mb-6">üéâ üèÜ üéâ</div>
                <h1 class="text-4xl md:text-5xl font-display font-bold text-yellow-500 mb-6">ESCAPE SUCCESSFUL!</h1>
                <p class="text-xl text-gray-600 mb-8 leading-relaxed">Congratulations! You have completed all challenges and unlocked the final door.</p>
                <button onclick="location.reload()" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-3 px-8 rounded-full text-lg transition">
                    Play Again
                </button>
            `;
            app.appendChild(container);
        }

        // --- LOGIC ---

        function nextStep() {
            state.step++;
            state.shuffledLeft = null; // Reset matching shuffle for next set
            state.currentMatchSelections = { left: null, right: null, found: [] }; // Reset matching state
            render();
            window.scrollTo(0,0);
        }

        window.handleMcqSelect = (stateKey, qIdx, optIdx) => {
            state[stateKey][qIdx] = optIdx;
            render();
        };

        window.checkMcq = (stateKey, total) => {
             const keys = Object.keys(state[stateKey]);
             if (keys.length < total) {
                 alert("Please answer all questions before proceeding!");
                 return;
             }
             render(); // Re-render checks correctness inside the renderer
        };

        window.handleMatchSelect = (side, id) => {
            // If already found, ignore
            if (state.currentMatchSelections.found.includes(id)) return;

            // Set selection
            if (side === 'left') state.currentMatchSelections.left = id;
            if (side === 'right') state.currentMatchSelections.right = id;

            // Check match
            if (state.currentMatchSelections.left !== null && state.currentMatchSelections.right !== null) {
                const l = state.currentMatchSelections.left;
                const r = state.currentMatchSelections.right;
                
                // Since id is the index in the original array, if left ID == right ID, it's a match
                if (l === r) {
                    state.currentMatchSelections.found.push(l);
                    state.currentMatchSelections.left = null;
                    state.currentMatchSelections.right = null;
                } else {
                    // Mismatch
                    setTimeout(() => {
                        state.currentMatchSelections.left = null;
                        state.currentMatchSelections.right = null;
                        render();
                    }, 500);
                }
            }
            render();
        };

        // --- DND LOGIC ---

        window.allowDrop = (ev) => {
            ev.preventDefault();
        };

        window.drag = (ev, word) => {
            ev.dataTransfer.setData("text", word);
        };

        window.drop = (ev, gapIndex) => {
            ev.preventDefault();
            const word = ev.dataTransfer.getData("text");
            if (word) {
                // If there was already a word here, it just goes back to pool implicitly on re-render
                state.gapPlacements[gapIndex] = word;
                state.gapChecked = false; // Reset check status on change
                render();
            }
        };

        window.dropToBank = (ev) => {
            ev.preventDefault();
            // Dragging to bank logic not strictly needed if we re-render bank based on availability
            // But if we support drag FROM gap TO bank:
            // We can add logic later. For now, click-to-return handles 'Gap -> Bank'
        };

        window.returnWord = (gapIndex) => {
            if (state.gapPlacements[gapIndex]) {
                delete state.gapPlacements[gapIndex];
                state.gapChecked = false;
                render();
            }
        };
        
        window.checkGaps = (total) => {
             state.gapChecked = true;
             // Check happens in render logic to colorize
             render(); 
        }

        window.revealAnswer = (idx) => {
            state.openQRevealed[idx] = true;
            render();
        }

        window.markReviewed = (idx) => {
            if (!state.openQReviewed) state.openQReviewed = {};
            state.openQReviewed[idx] = true;
            render();
        }

        // Init
        render();
    </script>
</body>
</html>
